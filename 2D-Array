package com.example.demo.service;

import com.lowagie.text.*;
import com.lowagie.text.pdf.*;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;

@Service
public class PdfService {

    public byte[] generateWaybillPdf() throws Exception {
        Document document = new Document(PageSize.A4, 36, 36, 54, 54);
        ByteArrayOutputStream baos = new ByteArrayOutputStream();

        PdfWriter writer = PdfWriter.getInstance(document, baos);
        document.open();

        // ========= HEADER =========
        Font headerFont = new Font(Font.HELVETICA, 14, Font.BOLD, Color.BLACK);
        Paragraph header = new Paragraph("Safexpress Logistics Pvt. Ltd.", headerFont);
        header.setAlignment(Element.ALIGN_CENTER);
        document.add(header);

        Paragraph subHeader = new Paragraph("DELIVERED - Digital Waybill", new Font(Font.HELVETICA, 12, Font.BOLD, Color.GREEN));
        subHeader.setAlignment(Element.ALIGN_CENTER);
        document.add(subHeader);
        document.add(new Paragraph(" "));

        // ========= WAYBILL + BOOKING TABLE =========
        PdfPTable infoTable = new PdfPTable(2);
        infoTable.setWidthPercentage(100);
        infoTable.setWidths(new float[]{50, 50});

        addCell(infoTable, "Waybill No.: 100018242559");
        addCell(infoTable, "Booking Branch: DELHI-15");

        addCell(infoTable, "Pickup Date: 11-JUN-2025");
        addCell(infoTable, "Ship Date: 12-JUN-2025");

        addCell(infoTable, "Delivery Gateway: NAGPUR-11");
        addCell(infoTable, "Destination Pincode: 440005");

        document.add(infoTable);
        document.add(new Paragraph(" "));

        // ========= CONSIGNOR & CONSIGNEE =========
        PdfPTable partyTable = new PdfPTable(2);
        partyTable.setWidthPercentage(100);
        partyTable.setWidths(new float[]{50, 50});

        PdfPCell consignor = new PdfPCell();
        consignor.addElement(new Paragraph("Consignor Name:\nJK FENNER(INDIA)LTD (NON VMI)(EX-W/H)"));
        consignor.addElement(new Paragraph("Address:\nBuilding No. 176/8, Ground Floor, M.G Road, Sector 83, Delhi, 110045"));
        consignor.setPadding(8);
        partyTable.addCell(consignor);

        PdfPCell consignee = new PdfPCell();
        consignee.addElement(new Paragraph("Consignee Name:\nLOGITEC INFRO INDIA PVT. LTD"));
        consignee.addElement(new Paragraph("Address:\nSadar Global Market, Gali No.8, Plot No.17, Sadar Metro Road, Sector 22, Bangalore, Karnataka - 560001"));
        consignee.setPadding(8);
        partyTable.addCell(consignee);

        document.add(partyTable);
        document.add(new Paragraph(" "));

        // ========= PACKAGE DETAILS =========
        PdfPTable pkgTable = new PdfPTable(4);
        pkgTable.setWidthPercentage(100);
        pkgTable.setWidths(new float[]{20, 20, 20, 40});

        addHeaderCell(pkgTable, "No. of Pkg");
        addHeaderCell(pkgTable, "Weight (kg)");
        addHeaderCell(pkgTable, "No. of Invoice");
        addHeaderCell(pkgTable, "Invoice Value");

        addCell(pkgTable, "10");
        addCell(pkgTable, "250");
        addCell(pkgTable, "2");
        addCell(pkgTable, "₹16,00,000/-");

        document.add(pkgTable);
        document.add(new Paragraph(" "));

        // ========= DIMENSIONS + INVOICES =========
        PdfPTable dimTable = new PdfPTable(3);
        dimTable.setWidthPercentage(100);
        dimTable.setWidths(new float[]{40, 30, 30});

        addHeaderCell(dimTable, "Dimensions (in)");
        addHeaderCell(dimTable, "Invoice");
        addHeaderCell(dimTable, "E-Waybill");

        for (int i = 0; i < 4; i++) {
            addCell(dimTable, "12x12x14 (1), 12x12x14 (1), 12x12x14 (1)");
            addCell(dimTable, "0987654321, 0987654321");
            addCell(dimTable, "125473829999, 125473829999");
        }

        document.add(dimTable);
        document.add(new Paragraph(" "));

        // ========= AMOUNT & MATERIAL =========
        PdfPTable amtTable = new PdfPTable(3);
        amtTable.setWidthPercentage(100);
        amtTable.setWidths(new float[]{33, 33, 34});

        addCell(amtTable, "Amount (₹): 2,50,000/-\nPDC Date: 30-OCT-24\nType: Draft\nFOR: CHAMINBHAI PATEL");
        addCell(amtTable, "Marketing Material");
        addCell(amtTable, "Fragile material - Handle with care");

        document.add(amtTable);
        document.add(new Paragraph(" "));

        // ========= CREDIT LINE =========
        PdfPCell creditCell = new PdfPCell(new Phrase("CREDIT - SFX0000558", new Font(Font.HELVETICA, 12, Font.BOLD, Color.BLACK)));
        creditCell.setHorizontalAlignment(Element.ALIGN_CENTER);
        creditCell.setPadding(10);
        creditCell.setBackgroundColor(Color.LIGHT_GRAY);

        PdfPTable creditTable = new PdfPTable(1);
        creditTable.setWidthPercentage(100);
        creditTable.addCell(creditCell);
        document.add(creditTable);
        document.add(new Paragraph(" "));

        // ========= BARCODE + AIRPLANE =========
        PdfPTable barcodeTable = new PdfPTable(2);
        barcodeTable.setWidthPercentage(100);
        barcodeTable.setWidths(new float[]{80, 20});

        // Barcode
        Barcode128 barcode = new Barcode128();
        barcode.setCode("100018242559");
        Image barcodeImg = barcode.createImageWithBarcode(writer.getDirectContent(), null, null);
        barcodeImg.scalePercent(120);

        PdfPCell barcodeCell = new PdfPCell(barcodeImg, true);
        barcodeCell.setBorder(Rectangle.NO_BORDER);
        barcodeCell.setHorizontalAlignment(Element.ALIGN_LEFT);
        barcodeTable.addCell(barcodeCell);

        // Airplane icon
        Image planeImg = Image.getInstance("src/main/resources/static/images/airplane.png");
        planeImg.scaleAbsolute(50, 30);

        PdfPCell planeCell = new PdfPCell(planeImg, true);
        planeCell.setBorder(Rectangle.NO_BORDER);
        planeCell.setHorizontalAlignment(Element.ALIGN_CENTER);
        barcodeTable.addCell(planeCell);

        document.add(barcodeTable);

        // ========= FOOTER =========
        document.add(new Paragraph(" "));
        Paragraph footer = new Paragraph("Contact: support@safexpress.com | +91-9999999999",
                new Font(Font.HELVETICA, 10, Font.ITALIC, Color.GRAY));
        footer.setAlignment(Element.ALIGN_CENTER);
        document.add(footer);

        document.close();
        return baos.toByteArray();
    }

    // ===== Helper methods =====
    private void addCell(PdfPTable table, String text) {
        PdfPCell cell = new PdfPCell(new Phrase(text, new Font(Font.HELVETICA, 10)));
        cell.setPadding(6);
        table.addCell(cell);
    }

    private void addHeaderCell(PdfPTable table, String text) {
        PdfPCell cell = new PdfPCell(new Phrase(text, new Font(Font.HELVETICA, 11, Font.BOLD, Color.BLACK)));
        cell.setBackgroundColor(Color.LIGHT_GRAY);
        cell.setPadding(6);
        table.addCell(cell);
    }
}