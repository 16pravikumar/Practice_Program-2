import com.lowagie.text.*;
import com.lowagie.text.pdf.*;
import org.springframework.stereotype.Service;

import java.awt.Color;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;

@Service
public class PdfService {

    public ByteArrayInputStream generateWaybillPdf() {
        Document document = new Document(PageSize.A4, 20, 20, 2vv0, 20);
        ByteArrayOutputStream out = new ByteArrayOutputStream();

        try {
            PdfWriter writer = PdfWriter.getInstance(document, out);
            document.open();

            // ===== HEADER =====
            PdfPTable headerTable = new PdfPTable(3);
            headerTable.setWidthPercentage(100);
            headerTable.setWidths(new float[]{40, 30, 30});

            Font headFont = new Font(Font.HELVETICA, 10, Font.BOLD, Color.BLACK);

            PdfPCell left = new PdfPCell(new Phrase("Digital Waybill", new Font(Font.HELVETICA, 14, Font.BOLD)));
            left.setBorder(Rectangle.NO_BORDER);
            left.setVerticalAlignment(Element.ALIGN_MIDDLE);
            headerTable.addCell(left);

            PdfPCell delivered = new PdfPCell(new Phrase("DELIVERED", new Font(Font.HELVETICA, 16, Font.BOLD, Color.GREEN)));
            delivered.setBorder(Rectangle.NO_BORDER);
            delivered.setHorizontalAlignment(Element.ALIGN_CENTER);
            headerTable.addCell(delivered);

            PdfPCell logo = new PdfPCell(new Phrase("SAFEXPRESS\nDistribution Redefined", headFont));
            logo.setHorizontalAlignment(Element.ALIGN_RIGHT);
            logo.setBorder(Rectangle.NO_BORDER);
            headerTable.addCell(logo);

            document.add(headerTable);
            document.add(new Paragraph(" "));

            // ===== WAYBILL INFO TABLE =====
            PdfPTable waybillTable = new PdfPTable(6);
            waybillTable.setWidthPercentage(100);
            waybillTable.setWidths(new float[]{20, 20, 20, 20, 20, 20});

            addCell(waybillTable, "Waybill No.", true);
            addCell(waybillTable, "1000 1824 2559", false);
            addCell(waybillTable, "Booking Branch", true);
            addCell(waybillTable, "DELHI-15", false);
            addCell(waybillTable, "Pickup Date", true);
            addCell(waybillTable, "11-JUN-2025", false);

            addCell(waybillTable, "Delivery Gateway", true);
            addCell(waybillTable, "NAGPUR-11", false);
            addCell(waybillTable, "Destination Pincode", true);
            addCell(waybillTable, "440005", false);
            addCell(waybillTable, "Ship Date", true);
            addCell(waybillTable, "12-JUN-2025", false);

            document.add(waybillTable);
            document.add(new Paragraph(" "));

            // Barcode
            Barcode128 barcode = new Barcode128();
            barcode.setCode("100018242559");
            Image barcodeImg = barcode.createImageWithBarcode(writer.getDirectContent(), null, null);
            barcodeImg.scalePercent(120);
            document.add(barcodeImg);
            document.add(new Paragraph(" "));

            // ===== CONSIGNOR =====
            Font boldFont = new Font(Font.HELVETICA, 11, Font.BOLD);
            document.add(new Paragraph("Consignor Name:", boldFont));
            document.add(new Paragraph("JK FENNER (INDIA) LTD (NON VMI) (EX-W/H)"));
            document.add(new Paragraph("Building No. 176/8, Ground Floor, M.G Road, Sector 83, Delhi, 110045"));
            document.add(new Paragraph(" "));

            // ===== CONSIGNEE =====
            document.add(new Paragraph("Consignee Name:", boldFont));
            document.add(new Paragraph("LOGITEC INFRO INDIA PVT. LTD"));
            document.add(new Paragraph("Sadar Global Market, Gali No.8, Plot No. 17, Sadar Metro Road, Sector 22, Bangalore, Karnataka - 560001"));
            document.add(new Paragraph(" "));

            // ===== PACKAGE SUMMARY =====
            PdfPTable summaryTable = new PdfPTable(4);
            summaryTable.setWidthPercentage(100);

            addHeader(summaryTable, "No. of Pkg");
            addHeader(summaryTable, "Actual Weight (kg)");
            addHeader(summaryTable, "No. of Invoice");
            addHeader(summaryTable, "Invoice Value");

            summaryTable.addCell("10");
            summaryTable.addCell("250");
            summaryTable.addCell("2");
            summaryTable.addCell("₹16,00,000/-");

            document.add(summaryTable);
            document.add(new Paragraph(" "));

            // ===== DETAILED TABLE (Dimensions, Invoice, E-Waybill) =====
            PdfPTable detailTable = new PdfPTable(3);
            detailTable.setWidthPercentage(100);
            detailTable.setWidths(new float[]{30, 30, 40});

            addHeader(detailTable, "Dimensions (in)");
            addHeader(detailTable, "Invoice");
            addHeader(detailTable, "E-Waybill");

            // Rows (sample data from screenshot)
            for (int i = 0; i < 4; i++) {
                detailTable.addCell("12x12x14 (1), 12x12x14 (1), 12x12x14 (1)");
                detailTable.addCell("0987654321, 0987654321, 0987654321");
                detailTable.addCell("125473829999, 125473829999, 125473829999");
            }

            document.add(detailTable);
            document.add(new Paragraph(" "));

            // ===== FOOTER SECTION =====
            PdfPTable footerTable = new PdfPTable(3);
            footerTable.setWidthPercentage(100);
            footerTable.setWidths(new float[]{33, 34, 33});

            PdfPCell amtCell = new PdfPCell(new Phrase("Amount (₹): 2,50,000/-\nPDC Date: 30-OCT-24\nType: Draft\nFOR: CHAMINBHAI PATEL"));
            footerTable.addCell(amtCell);

            PdfPCell midCell = new PdfPCell(new Phrase("Marketing Material", boldFont));
            midCell.setHorizontalAlignment(Element.ALIGN_CENTER);
            footerTable.addCell(midCell);

            PdfPCell fragileCell = new PdfPCell(new Phrase("Fragile material - Handle with care", new Font(Font.HELVETICA, 10, Font.ITALIC, Color.RED)));
            fragileCell.setHorizontalAlignment(Element.ALIGN_CENTER);
            footerTable.addCell(fragileCell);

            document.add(footerTable);

            // Credit Row
            PdfPTable creditTable = new PdfPTable(2);
            creditTable.setWidthPercentage(100);

            PdfPCell credit = new PdfPCell(new Phrase("CREDIT", new Font(Font.HELVETICA, 12, Font.BOLD, Color.WHITE)));
            credit.setBackgroundColor(Color.GREEN);
            credit.setHorizontalAlignment(Element.ALIGN_CENTER);
            creditTable.addCell(credit);

            PdfPCell sfx = new PdfPCell(new Phrase("SFX0000558", new Font(Font.HELVETICA, 12, Font.BOLD)));
            sfx.setHorizontalAlignment(Element.ALIGN_CENTER);
            creditTable.addCell(sfx);

            document.add(creditTable);

            document.close();

        } catch (Exception e) {
            e.printStackTrace();
        }
        return new ByteArrayInputStream(out.toByteArray());
    }

    private void addCell(PdfPTable table, String text, boolean bold) {
        Font font = bold ? new Font(Font.HELVETICA, 9, Font.BOLD) : new Font(Font.HELVETICA, 9);
        PdfPCell cell = new PdfPCell(new Phrase(text, font));
        cell.setPadding(5);
        table.addCell(cell);
    }

    private void addHeader(PdfPTable table, String text) {
        Font font = new Font(Font.HELVETICA, 9, Font.BOLD, Color.WHITE);
        PdfPCell cell = new PdfPCell(new Phrase(text, font));
        cell.setBackgroundColor(Color.DARK_GRAY);
        cell.setHorizontalAlignment(Element.ALIGN_CENTER);
        cell.setPadding(5);
        table.addCell(cell);
    }
}